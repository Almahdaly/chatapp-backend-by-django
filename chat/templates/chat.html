<!DOCTYPE html>
<html>
<head>
  <title>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</title>
</head>
<body>
  <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ {{ user.username }}</h2>

  <form method="post">
    {% csrf_token %}
    <input type="text" name="content" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." required>
    <button type="submit">Ø¥Ø±Ø³Ø§Ù„</button>
  </form>

  <hr>

  {% for msg in messages %}
    <p>
      <strong>{{ msg.user.username }}</strong>: {{ msg.content }}
      <small>({{ msg.created_at|date:"H:i:s" }})</small>
      {% if msg.user == user %}
        <a href="{% url 'chat:delete' msg.id %}">ğŸ—‘ï¸</a>
      {% endif %}
    </p>
  {% empty %}
    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„.</p>
  {% endfor %}

 <script>
  const socket = new WebSocket('ws://' + window.location.host + '/ws/chat/');

  socket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    const chat = document.createElement('p');
    let deleteBtn = '';

    if (data.username === "{{ user.username }}") {
      deleteBtn = ` <a href="/chat/delete/${data.id}/">ğŸ—‘ï¸</a>`;
    }

    chat.innerHTML = `<strong>${data.username}</strong>: ${data.message}${deleteBtn}`;
    document.body.appendChild(chat);
  };

  const form = document.querySelector('form');
  form.onsubmit = function(e) {
    e.preventDefault();
    const input = document.querySelector('input[name="content"]');
    const message = input.value;
    const username = "{{ user.username }}";

    socket.send(JSON.stringify({
      'message': message,
      'username': username
    }));

    input.value = '';
  };
</script>

</body>
</html>


